# 项目进度记录

## [2025-06-09]

### 已完成

- 初始化项目基础结构
- 配置 Gradle 构建系统
- 创建基础文档架构
  - docs/README.md
  - docs/CHANGELOG.md
  - docs/PROGRESS.md

### 进行中

- 项目基础功能设计

### 计划

- 实现基础传送功能
- 添加配置系统
- 添加命令系统

### 问题与解决方案

- 暂无问题

## [2025-06-09 17:35]

### 已完成

- 修复了 `/back` 命令在同维度传送后不工作的问题
  - 在 CommandHome.java 的 executeHome 方法中添加位置记录
  - 在 CommandTPA.java 的 executeTpAccept 方法中添加位置记录
  - 在 CommandTPAHere.java 的 executeTpAccept 方法中添加位置记录

### 问题与解决方案

- 问题：当同维度内使用 `/home`、`/tpa` 等命令后，无法使用 `/back` 返回上一位置
- 原因：位置记录逻辑只在实体卸载（跨维度传送）时触发
- 解决方案：在每个传送命令执行前手动调用 `CommandBack.recordPreviousLocation()` 记录位置

## [2025-06-09 17:40]

### 已完成

- 增强了传送位置安全性
  - 添加了完全方块高度检查机制
  - 在 CommandBack 中添加 `ensureFullBlockHeight` 方法
  - 修改 `sethome` 命令，使其直接记录安全的完全方块高度

### 问题与解决方案

- 问题：当玩家站在非完全方块（如半砖、楼梯）上时，传送可能不安全
- 解决方案：
  - 添加了方法检查脚下方块是否为完全方块
  - 如果不是完全方块，寻找最近的完全方块高度
  - 在设置家时提供用户反馈，告知位置已调整到安全高度

## [2025-06-09 17:51]

### 已完成

- 优化了完全高度判断算法
  - 改为基于坐标值判断而非方块状态
  - 判断标准：Y 坐标必须是整数或 0.5 的倍数
  - 如果不是，则自动调整到下一个更大的整数或 0.5 的倍数

### 问题与解决方案

- 问题：原有算法没有正确处理 Y 坐标值
- 解决方案：
  - 使用数学方法判断坐标是否为整数或 0.5 的倍数
  - 通过 `Math.ceil(exactY * 2) / 2.0` 计算下一个 0.5 的倍数
  - 在 `sethome` 命令中显示原始高度和调整后的高度

## [2025-06-09 17:59]

### 已完成

- 修复了坐标处理机制
  - 使用玩家的精确浮点坐标而非整数方块坐标
  - 重构 `PreviousLocation` 类，使用双精度浮点数存储坐标
  - 改进了标准高度判断和调整算法

### 问题与解决方案

- 问题：使用 `player.getBlockPos()` 获取的坐标已经被取整，无法正确检测非标准高度
- 解决方案：
  - 使用 `player.getX()`, `player.getY()`, `player.getZ()` 获取精确浮点坐标
  - 将 `ensureFullBlockHeight` 方法改为 `ensureStandardHeight`，直接处理浮点数高度
  - 将位置存储从 `BlockPos` 改为精确的 `double` 坐标

## [2025-06-09 18:09]

### 已完成

- 完成了数据库架构升级
  - 修改数据库表结构，将坐标列从 INTEGER 改为 REAL 类型
  - 添加数据库迁移功能，自动处理现有数据
  - 更新 DatabaseManager 接口以支持双精度浮点坐标

### 问题与解决方案

- 问题：DatabaseManager 只接受整数坐标，导致编译错误
- 解决方案：
  - 修改数据库表结构将坐标字段从 INTEGER 改为 REAL
  - 重构 HomeLocation 类使用 double 类型存储坐标
  - 添加自动迁移逻辑，确保向后兼容
  - 更新相关显示逻辑，使用 %.2f 格式显示浮点坐标

## [2025-06-09 18:14]

### 已完成

- 修复了 Java lambda 表达式编译错误
  - 在 CommandHome.java 中修复了 lambda 表达式引用非 final 变量的问题
  - 创建了 final 变量副本来存储 adjustedY 和 exactY 值

### 问题与解决方案

- 问题：从 lambda 表达式引用的本地变量必须是最终变量或实际上的最终变量
- 原因：Java 要求 lambda 表达式中引用的外部局部变量必须是 final 或 effectively final 的
- 解决方案：在 lambda 表达式前创建 final 副本保存需要在 lambda 中使用的变量

## [2025-06-09 18:22]

### 已完成

- 修复了坐标处理逻辑
  - 现在只调整 Y 坐标到标准高度（整数或 0.5 的倍数）
  - 完全保留 X 和 Z 坐标的精确值，不做任何调整
  - 更新了代码中的相关注释以明确此逻辑

### 问题与解决方案

- 问题：原先的实现可能对所有坐标进行了处理
- 解决方案：
  - 明确调整和保存逻辑，只对 Y 坐标应用标准化规则
  - 确保在 CommandBack 和 CommandHome 中都保留 X 和 Z 的精确值

## [2025-06-09 18:44]

### 已完成

- 完全移除了坐标标准化处理
  - 使用玩家的完全原始精确坐标，不进行任何调整
  - 移除了 CommandHome 中的 Y 坐标调整代码
  - 移除了 CommandBack 中的 ensureStandardHeight 方法及相关调用
  - 简化了玩家位置记录逻辑

### 问题与解决方案

- 问题：之前的 Y 坐标标准化可能在特定情况下导致位置不准确
- 解决方案：完全保留原始精确坐标，确保传送到玩家原位置
